<?php
/**
 *
 *  Copyright (C) 2017 paj@gaiterjones.com
 *
 *
 */

namespace PAJ\Application\AmazonDev\Alexa\Intent;

/**
 * ALEXA INTENT DATA CLASS
 *
 */
class MalwareFactsData {

	static function getNewFact($_sessionData,$_search=false,$_intentName)
	{

		$_target='getNewFact';

		$_maxFacts=1;
		$_obj=new Helper();

			if (isset($_sessionData['data']))
			{
				$_newFact=$_obj->getNewFact($_intentName,$_maxFacts,$_sessionData['data'],$_search);
			} else {
				$_newFact=$_obj->getNewFact($_intentName,$_maxFacts,array('0'),$_search);
			}
				unset($_obj);

		if ($_newFact)
		{
			// new fact
			//
			$_factData=array($_newFact[0]['id']);
			$_count=0;

			// get search data from session
			//
			if (isset($_sessionData['search']))
			{
				if ($_sessionData['search']) {$_search=$_sessionData['search'];}
			}
			// get already heard=excluded id data from session
			//
			if (isset($_sessionData['data']))
			{
				$_factData=$_sessionData['data'];
				array_push($_factData,$_newFact[0]['id']);
			}
			// get count
			if (isset($_sessionData['count']))
			{
				$_count=$_sessionData['count'];
			}
			$_count++;

			return array(
				'intent' => array(
					'response' => "<speak>". ucfirst($_newFact[0]['text']). ($_count > 5 ? "" : " Would you like another ". ($_search ? ucwords($_search) : str_replace('Facts', '',$_intentName)). " fact?"). "<audio src='https://www.medazzaland.co.uk/dropbox/dev/PAJ/www/Amazon/Alexa/audio/mp3/prompt-ping.mp3' /></speak>",
					'outputssml' => true,
					'card' => array(
						'title' => ucwords($_newFact[0]['subject']). ' - '. $_newFact[0]['type'],
						'text' => $_newFact[0]['text'],
						'image' => $_intentName
					),
					'target' => $_target,
					'status' => false,
					'sessionattributes' => array('object' => $_intentName, 'prompt' => true, 'target' => $_target, 'search' => $_search, 'count' => $_count,'data' => $_factData),
					'endsession' => false
				)
			);

		} else {

			// no fact
			//
			return array(
				'intent' => array(
					'response' => 'Sorry, there are no more new facts for this session available!',
					'card' => false,
					'target' => $_target,
					'status' => false,
					'sessionattributes' => false,
					'endsession' => true
				)
			);

		}
	}

}
?>
